<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Book a Cleaning • AJK Cleaning Company</title>
    <meta name="description" content="Book trusted cleaners in Bischofsheim. Fast online booking with instant price estimates, verified teams, and satisfaction guarantee.">
    <!-- Stripe.js Script -->
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./dist/output.css">
    <script>
        // Tailwind config is now in tailwind.config.js
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Favicon - Optimized for Google Search Results -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Additional favicon formats for better compatibility -->
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16">

    <style>
        :root {
            --primary-500: #2563eb; /* blue-600 */
            --primary-600: #1d4ed8; /* blue-700 */
            --accent-500: #0d9488;  /* teal-600 */
            --accent-600: #087f75;  /* teal-700 */
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-400: #9ca3af;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .font-poppins { font-family: 'Poppins', sans-serif; }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            animation: backgroundShift 15s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 32px 64px -12px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .main-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            z-index: -1;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: var(--shadow-lg);
            animation: glassFloat 6s ease-in-out infinite;
        }
        
        @keyframes glassFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }
        
        /* Language Switcher Styles */
        .lang-btn {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            background: white;
            color: #6b7280;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lang-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .lang-btn.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .card-hover {
            transition: all .3s cubic-bezier(.4,0,.2,1);
            position: relative;
            overflow: hidden;
        }
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .card-hover:hover::before {
            left: 100%;
        }
        
        /* Floating Label Form Fields */
        .field { position: relative; }
        .field .field-icon { position: absolute; left: 1rem; top: 1rem; color: var(--gray-400); transition: color .2s; pointer-events: none; }
        .field .form-input { transition: border-color .2s; -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-left: 2.75rem; }
        .form-input.error { border-color: #ef4444 !important; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important; }
        .error-message { display: none; color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
        .error-message:not([style*="display: none"]) { display: block !important; }
        
        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .loading-screen.show {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
            color: white;
            max-width: 400px;
            padding: 2rem;
        }
        
        .loading-spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
        }
        
        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }
        
        .spinner-ring:nth-child(2) {
            border-top-color: #10b981;
            animation-delay: -0.5s;
            animation-duration: 2s;
        }
        
        .spinner-ring:nth-child(3) {
            border-top-color: #f59e0b;
            animation-delay: -1s;
            animation-duration: 2.5s;
        }
        
        .loading-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }
        
        .loading-subtitle {
            font-size: 1rem;
            color: #d1d5db;
            margin-bottom: 2rem;
        }
        
        .loading-progress {
            width: 100%;
            margin-top: 1rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 2px;
            animation: progress 3s ease-in-out infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        .field select.form-input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right .7rem center; background-repeat: no-repeat; background-size: 1.25em; padding-right: 2.5rem; padding-left: 1rem;
        }
        .field .form-input:focus { border-color: var(--primary-500); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); outline: none; }
        .field .form-input:focus ~ .field-icon { color: var(--primary-600); }
        .field .form-input:focus + label, .field .form-input:not(:placeholder-shown) + label, .field select.form-input + label {
            transform: translateY(-1.3rem) scale(.8); background: var(--white); padding: 0 .4rem;
        }
        .field input.form-input:not(:placeholder-shown) + label, .field .form-input:focus + label { left: 2.5rem; }
        .field select.form-input + label { left: .8rem; }
        .field label { position: absolute; left: 2.75rem; top: 1rem; transition: all .2s ease-in-out; pointer-events: none; color: var(--gray-400); }
        .field select ~ label { left: 1rem; }

        .form-input.error { 
            border-color: #ef4444 !important; 
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            animation: shake 0.5s ease-in-out;
        }
        .form-input.valid {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }
        .error-message { 
            color: #ef4444; 
            font-size: 0.875rem; 
            margin-top: 0.25rem; 
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        .success-message {
            color: #10b981;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Real-time validation indicators */
        .field {
            position: relative;
        }
        .field .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .field .validation-icon.show {
            opacity: 1;
        }
        .field .validation-icon.error {
            color: #ef4444;
        }
        .field .validation-icon.success {
            color: #10b981;
        }
        
        /* Mobile optimization for forms */
        @media (max-width: 768px) {
            .wizard-steps {
                flex-direction: column;
                gap: 8px;
                padding: 0.5rem;
            }
            .wizard-step {
                width: 100%;
                padding: 8px 12px;
                font-size: 0.875rem;
            }
            .form-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px 16px;
                min-height: 44px; /* Touch-friendly */
            }
            .field .form-input {
                padding-left: 2.5rem;
            }
            .field .field-icon {
                left: 0.75rem;
                top: 0.75rem;
            }
            .field label {
                left: 2.5rem;
                top: 0.75rem;
            }
        }
        
        /* Enhanced Wizard Steps with Progress Indicators */
        .wizard-steps { 
            counter-reset: step; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .wizard-step {
            display: flex;
            align-items: center;
            opacity: 0.6;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 12px 20px;
            border-radius: 12px;
            position: relative;
            flex: 1;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: 2px solid transparent;
        }
        .wizard-step:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }
        .wizard-step.active {
            opacity: 1;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        .wizard-step.completed {
            opacity: 1;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .wizard-step::before {
            counter-increment: step;
            content: counter(step);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 2.5rem; 
            height: 2.5rem;
            border-radius: 99px;
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            color: #6b7280;
            font-weight: 700;
            margin-right: 0.75rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .wizard-step.active { 
            opacity: 1; 
            background: rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }
        .wizard-step.active::before { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
            color: white; 
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            transform: scale(1.1);
        }
        .wizard-step.completed::before { 
            content: '\f00c'; 
            font-family: 'Font Awesome 6 Free'; 
            font-weight: 900; 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        .wizard-connector { flex-grow: 1; height: 2px; background-color: var(--gray-200); margin: 0 0.5rem; }

        .a-focus:focus-visible { outline: 3px solid rgba(37,99,235,0.2); outline-offset: 2px; border-radius: 6px; }

        /* Step Animations */
        #wizard { overflow: hidden; }
        .step {
            transition: opacity .3s ease-in-out, transform .3s ease-in-out;
            will-change: transform, opacity;
        }
        .step.hidden-left { position: absolute; opacity: 0; transform: translateX(-50px); pointer-events: none; }
        .step.hidden-right { position: absolute; opacity: 0; transform: translateX(50px); pointer-events: none; }
        
        .package.selected {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.05));
            border-color: var(--primary-500) !important;
            box-shadow: 
                0 8px 25px rgba(37, 99, 235, 0.2),
                0 0 0 1px rgba(37, 99, 235, 0.1);
            transform: translateY(-4px);
        }

        /* Booking Type Selection Styles */
        .booking-type-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .booking-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .booking-type-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .booking-type-card:hover::before {
            left: 100%;
        }
        
        .booking-type-card.selected {
            border-color: var(--primary-500) !important;
            background: linear-gradient(135deg, 
                rgba(37, 99, 235, 0.08), 
                rgba(37, 99, 235, 0.03),
                rgba(255, 255, 255, 0.9));
            box-shadow: 
                0 8px 25px rgba(37, 99, 235, 0.2),
                0 0 0 2px rgba(37, 99, 235, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px) scale(1.01);
        }
        
        .booking-type-card.selected .w-3 {
            opacity: 1 !important;
            transform: scale(1.2);
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .booking-type-card.selected .border-slate-300 {
            border-color: var(--primary-500) !important;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        .booking-type-card h4 {
            transition: color 0.3s ease;
        }
        
        .booking-type-card.selected h4 {
            color: #1e40af;
            font-weight: 700;
        }
        
        .booking-type-card p {
            transition: color 0.3s ease;
        }
        
        .booking-type-card.selected p {
            color: #475569;
        }
        
        /* Radio button animation */
        .booking-type-card input[type="radio"]:checked + div .w-6 {
            animation: radioPulse 0.6s ease-out;
        }
        
        @keyframes radioPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Package cards enhanced styling */
        .package {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .package::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .package:hover::before {
            left: 100%;
        }
        
        .package:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 30px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(59, 130, 246, 0.2);
        }
        
        .package.selected {
            background: linear-gradient(135deg, 
                rgba(37, 99, 235, 0.08), 
                rgba(37, 99, 235, 0.03),
                rgba(255, 255, 255, 0.95));
            border-color: var(--primary-500) !important;
            box-shadow: 
                0 12px 30px rgba(37, 99, 235, 0.2),
                0 0 0 2px rgba(37, 99, 235, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-4px) scale(1.02);
        }
        
        .package.selected .font-semibold {
            color: #1e40af;
        }
        
        .package.selected .font-bold {
            color: #1d4ed8;
            text-shadow: 0 1px 2px rgba(37, 99, 235, 0.1);
        }
        
        /* Enhanced section spacing and typography */
        .booking-type-section {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.4));
            border-radius: 20px;
            padding: 2rem;
            margin: 1.5rem 0;
            border: 1px solid rgba(226, 232, 240, 0.5);
        }
        
        .package-section {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1px solid rgba(226, 232, 240, 0.3);
        }
        
        /* Improved button styling */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 
                0 8px 20px rgba(59, 130, 246, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: linear-gradient(135deg, #2563eb, #1e40af); 
            transform: translateY(-2px); 
            box-shadow: 
                0 12px 30px rgba(59, 130, 246, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        
        /* Enhanced form styling */
        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.1),
                0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        
        /* Improved summary styling */
        .summary-container {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.9), rgba(241, 245, 249, 0.6));
            border-radius: 16px;
            border: 1px solid rgba(226, 232, 240, 0.5);
        }
        
        .summary-item {
            transition: all 0.3s ease;
        }
        
        .summary-item:hover {
            background: rgba(59, 130, 246, 0.05);
            border-radius: 8px;
            padding: 0.5rem;
            margin: -0.5rem;
        }
        
        /* Micro-interactions and loading states */
        .booking-type-card:active {
            transform: scale(0.98);
        }
        
        .package:active {
            transform: scale(0.98);
        }
        
        /* Smooth transitions for dynamic content */
        .package-selection-transition {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced focus states for accessibility */
        .booking-type-card:focus-within {
            outline: 3px solid rgba(59, 130, 246, 0.3);
            outline-offset: 2px;
        }
        
        .package:focus-within {
            outline: 3px solid rgba(59, 130, 246, 0.3);
            outline-offset: 2px;
        }
        
        /* Improved loading states */
        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Mobile responsiveness improvements */
        @media (max-width: 768px) {
            .booking-type-card {
                padding: 1rem;
            }
            
            .package {
                padding: 1rem;
            }
            
            .booking-type-card h4 {
                font-size: 1rem;
            }
            
            .package h4 {
                font-size: 1rem;
            }
            
            .booking-type-section {
                padding: 1rem;
                margin: 1rem 0;
            }
            
            .package-section {
                padding: 1rem;
                margin: 0.5rem 0;
            }
        }
        
        @media (max-width: 480px) {
            .booking-type-card {
                padding: 0.75rem;
            }
            
            .package {
                padding: 0.75rem;
            }
            
            .booking-type-card .w-10 {
                width: 2rem;
                height: 2rem;
            }
            
            .package .w-12 {
                width: 2.5rem;
                height: 2.5rem;
            }
        }

        /* Custom Calendar */
        #calendar-grid .day:not(.disabled):hover { background-color: #dbeafe; }
        #calendar-grid .day.selected { background-color: var(--primary-500) !important; color: white; font-weight: 600; }
        .time-slot:hover, .time-slot.selected { background-color: var(--primary-500); color: white; border-color: var(--primary-600); }

        /* Modern button styles */
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; }
        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
            color: white; 
            box-shadow: 
                0 8px 20px rgba(59, 130, 246, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover:not(:disabled) { 
            background: linear-gradient(135deg, #2563eb, #1e40af); 
            transform: translateY(-3px); 
            box-shadow: 
                0 12px 30px rgba(59, 130, 246, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        .btn-secondary { background-color: var(--gray-200); color: var(--gray-800); }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-accent { background-color: var(--accent-500); color: white; }
        .btn-accent:hover { background-color: var(--accent-600); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .quantity-btn:hover:not(:disabled) { background: #e2e8f0; }
        .quantity-btn:active:not(:disabled) { transform: scale(0.95); }
        .quantity-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Loader */
        .hidden { display: none !important; }
        .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        
        /* Ensure button text is visible by default */
        #button-text { display: inline; }
        #spinner { display: none; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Success Animation */
        .success-checkmark { width: 80px; height: 80px; margin: 2rem auto; }
        .check-icon { width: 80px; height: 80px; position: relative; border-radius: 50%; box-sizing: content-box; border: 4px solid var(--accent-500); }
        .check-icon::before { top: 3px; left: -2px; width: 30px; transform-origin: 100% 50%; border-radius: 100px 0 0 100px; content: ""; }
        .check-icon::after { top: 0; left: 30px; width: 60px; transform-origin: 0 50%; border-radius: 0 100px 100px 0; animation: rotate-circle 4.25s ease-in; content: ""; }
        .check-icon::before, .check-icon::after { content: ''; height: 100px; position: absolute; background: #f8fafc; transform: rotate(-45deg); }
        .icon-line { height: 5px; background-color: var(--accent-500); display: block; border-radius: 2px; position: absolute; z-index: 10; }
        .icon-line.line-tip { top: 46px; left: 14px; width: 25px; transform: rotate(45deg); animation: icon-line-tip .75s; }
        .icon-line.line-long { top: 38px; right: 8px; width: 47px; transform: rotate(-45deg); animation: icon-line-long .75s; }
        .icon-circle { top: -4px; left: -4px; z-index: 10; width: 80px; height: 80px; border-radius: 50%; position: absolute; box-sizing: content-box; border: 4px solid rgba(13, 148, 136, .5); }
        .icon-fix { top: 8px; width: 5px; left: 26px; z-index: 1; width: 5px; height: 85px; position: absolute; transform: rotate(-45deg); background-color: #f8fafc; }
        @keyframes rotate-circle { 0%, 12% { transform: rotate(-45deg); } 100% { transform: rotate(-405deg); } }
        @keyframes icon-line-tip { 0%, 54% { width: 0; left: 1px; top: 19px; } 70% { width: 50px; left: -8px; top: 37px; } 84% { width: 17px; left: 21px; top: 48px; } 100% { width: 25px; left: 14px; top: 45px; } }
        @keyframes icon-line-long { 0%, 65% { width: 0; right: 46px; top: 54px; } 84% { width: 55px; right: 0px; top: 35px; } 100% { width: 47px; right: 8px; top: 38px; } }
    
        #terms-modal.hidden, #privacy-modal.hidden { display: none; }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .max-w-7xl { max-width: 100%; }
            .px-6 { padding-left: 1rem; padding-right: 1rem; }
            .grid.lg\\:grid-cols-3 { grid-template-columns: 1fr; gap: 1.5rem; }
            .p-6 { padding: 1rem; }
            .sm\\:p-8 { padding: 1rem; }
            .wizard-steps { flex-direction: column; gap: 0.5rem; }
            .wizard-step { width: 100%; text-align: center; padding: 0.75rem; }
            .wizard-connector { display: none; }
            .package-grid { grid-template-columns: 1fr; gap: 0.75rem; }
            .package { padding: 1rem; }
            .form-row { flex-direction: column; gap: 0.75rem; }
            .form-row .form-group { flex: 1; }
            .btn-primary { width: 100%; padding: 0.875rem; }
            .calendar-grid { grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
            .calendar-day { padding: 0.5rem 0.25rem; font-size: 0.8rem; }
            .time-slots { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .time-slot { padding: 0.5rem; font-size: 0.8rem; }
            .success-message { padding: 1.5rem; text-align: center; }
            .success-message h2 { font-size: 1.5rem; }
            .success-message p { font-size: 0.9rem; }
            .sticky.top-0 { position: relative; }
            .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
            .text-lg { font-size: 1rem; }
            .text-xs { font-size: 0.7rem; }
            .h-12 { height: 2.5rem; }
            .w-12 { width: 2.5rem; }
        }
        
        @media (max-width: 480px) {
            .px-6 { padding-left: 0.5rem; padding-right: 0.5rem; }
            .p-6 { padding: 0.75rem; }
            .wizard-step { padding: 0.5rem; font-size: 0.8rem; }
            .package { padding: 0.75rem; }
            .package h3 { font-size: 1rem; }
            .package .price { font-size: 1.25rem; }
            .btn-primary { padding: 0.75rem; font-size: 0.875rem; }
            .calendar-day { padding: 0.25rem; font-size: 0.7rem; }
            .time-slot { padding: 0.375rem; font-size: 0.75rem; }
            .success-message { padding: 1rem; }
            .success-message h2 { font-size: 1.25rem; }
            .success-message p { font-size: 0.8rem; }
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevent zoom on iOS */
            }
            .summary-container {
                padding: 1rem;
            }
            .summary-item {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body class="antialiased text-slate-700 bg-slate-50">

<div class="relative min-h-screen">
    <header class="sticky top-0 z-20 bg-white/80 backdrop-blur-lg border-b border-slate-200/80">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center gap-3 a-focus" aria-label="AJK Cleaning Home">
                <img src="images/logo.webp" alt="AJK Cleaning logo" class="h-16 w-16 rounded-lg shadow-sm object-contain">
                <div>
                    <div class="font-poppins text-lg font-bold text-slate-800">AJK Cleaning</div>
                    <div class="text-xs text-slate-500">Bischofsheim • Trusted & Verified</div>
                </div>
            </a>
            <div class="flex items-center space-x-4">
                <!-- Language Switcher -->
                <div class="flex items-center space-x-2">
                    <button id="lang-en" class="lang-btn active" data-lang="en">EN</button>
                    <span class="text-gray-400">|</span>
                    <button id="lang-de" class="lang-btn" data-lang="de">DE</button>
                </div>
                <div class="text-right text-sm">
                    <div class="text-slate-700 font-medium">International Support</div>
                    <a href="tel:+4917661852286" class="mt-1 inline-block text-blue-600 font-semibold a-focus">+49 176 61852286</a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 grid lg:grid-cols-3 gap-10 items-start pt-8">
        <div class="lg:col-span-2">
            <!-- Form Wizard -->
            <div class="bg-white p-6 sm:p-8 rounded-2xl border border-slate-200 shadow-sm">
                <!-- Step indicators -->
                <div class="wizard-steps flex items-center mb-6 sm:mb-8">
                    <div class="wizard-step" data-step-id="1">Package</div>
                    <div class="wizard-connector"></div>
                    <div class="wizard-step" data-step-id="2">Schedule</div>
                    <div class="wizard-connector"></div>
                    <div class="wizard-step" data-step-id="3">Details</div>
                    <div class="wizard-connector"></div>
                    <div class="wizard-step" data-step-id="4">Payment</div>
                </div>

                <div id="wizard" class="relative">
                    <!-- STEP 1: Package -->
                    <form class="step" data-step="1">
                        <h3 class="text-2xl font-poppins font-bold text-slate-800" data-translate="package-title">Choose a Package</h3>
                        <p class="text-slate-500 mt-1" data-translate="package-desc">Select the type of cleaning that fits your needs.</p>
                        
                        <!-- Booking Type Selection -->
                        <div class="booking-type-section mt-6 mb-8">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-calendar-check text-blue-600 text-sm"></i>
                                </div>
                                <label class="text-xl font-bold text-slate-800">Choose Your Booking Type</label>
                            </div>
                            <div class="grid sm:grid-cols-2 gap-6">
                                <label class="booking-type-card cursor-pointer p-6 border-2 border-slate-200 rounded-2xl hover:border-blue-300 transition-all duration-300" data-booking-type="one-time">
                                    <input type="radio" name="booking-type" value="one-time" class="sr-only" checked>
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center">
                                                    <i class="fas fa-broom text-blue-600 text-lg"></i>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-slate-800 text-lg">One-Time Cleaning</h4>
                                                    <p class="text-sm text-slate-500">Single cleaning service</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2 text-xs text-slate-400">
                                                <i class="fas fa-check-circle"></i>
                                                <span>Perfect for special occasions</span>
                                            </div>
                                        </div>
                                        <div class="w-6 h-6 border-2 border-slate-300 rounded-full flex items-center justify-center ml-4">
                                            <div class="w-3 h-3 bg-blue-600 rounded-full opacity-0 transition-all duration-300"></div>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="booking-type-card cursor-pointer p-6 border-2 border-slate-200 rounded-2xl hover:border-blue-300 transition-all duration-300" data-booking-type="subscription">
                                    <input type="radio" name="booking-type" value="subscription" class="sr-only">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center">
                                                    <i class="fas fa-sync-alt text-green-600 text-lg"></i>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-slate-800 text-lg">Subscription</h4>
                                                    <p class="text-sm text-slate-500">Regular recurring service</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2 text-xs text-slate-400">
                                                <i class="fas fa-check-circle"></i>
                                                <span>Best value for regular cleaning</span>
                                            </div>
                                        </div>
                                        <div class="w-6 h-6 border-2 border-slate-300 rounded-full flex items-center justify-center ml-4">
                                            <div class="w-3 h-3 bg-blue-600 rounded-full opacity-0 transition-all duration-300"></div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="package-section">
                            <div id="package-selection" class="grid sm:grid-cols-2 gap-4">
                                <!-- JS will inject packages here -->
                            </div>
                        </div>
                        <div class="mt-6 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <label class="text-sm font-medium text-slate-600 flex items-center gap-2"><i class="fas fa-users text-slate-400"></i><span data-translate="cleaners-label">Cleaners</span></label>
                                <div class="inline-flex items-center gap-1 bg-white rounded-full p-1 shadow-sm border">
                                    <button type="button" class="quantity-btn h-8 w-8 text-lg rounded-full a-focus hover:bg-slate-100 transition-colors" data-field="cleaners" data-amount="-1" aria-label="Decrease cleaners">-</button>
                                    <div id="cleaners-count" class="px-2 font-semibold w-8 text-center">1</div>
                                    <button type="button" class="quantity-btn h-8 w-8 text-lg rounded-full a-focus hover:bg-slate-100 transition-colors" data-field="cleaners" data-amount="1" aria-label="Increase cleaners">+</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" data-action="next">Next <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                    </form>

                    <!-- STEP 2: Schedule -->
                    <form class="step hidden-right" data-step="2">
                        <h3 class="text-2xl font-poppins font-bold text-slate-800" data-translate="schedule-title">Schedule Your Cleaning</h3>
                        <p class="text-slate-500 mt-1" data-translate="schedule-desc">Pick a date and time that works for you.</p>
                        
                        <div id="schedule-fields">
                            <div class="mt-6 grid md:grid-cols-5 gap-6">
                                <div class="md:col-span-3">
                                    <div class="flex items-center justify-between mb-4">
                                        <button type="button" id="prev-month" class="p-2 rounded-full w-10 h-10 a-focus hover:bg-slate-100 disabled:opacity-50" aria-label="Previous month"><i class="fas fa-chevron-left"></i></button>
                                        <h4 id="month-year" class="font-bold text-lg text-slate-700 text-center"></h4>
                                        <button type="button" id="next-month" class="p-2 rounded-full w-10 h-10 a-focus hover:bg-slate-100 disabled:opacity-50" aria-label="Next month"><i class="fas fa-chevron-right"></i></button>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 text-center text-sm text-slate-500 font-medium mb-2">
                                        <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
                                    </div>
                                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="mb-4">
                                        <label class="text-sm font-medium text-slate-600 mb-2 block" data-translate="time-label">Available Slots</label>
                                        <div id="time-slots" class="grid grid-cols-2 gap-2"></div>
                                    </div>
                                    <div class="mb-4 field">
                                        <i class="field-icon fas fa-ruler-combined"></i>
                                        <input id="property-size" type="number" min="1" max="300" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" ">
                                        <label for="property-size" data-translate="size-label">Property Size (m²)</label>
                                        <div id="duration-suggestion" class="hidden mt-2 text-xs text-slate-600 bg-blue-50 border border-blue-200 rounded-md p-2"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-slate-600 flex items-center gap-2"><i class="fas fa-hourglass-half text-slate-400"></i><span data-translate="duration-label">Duration (hours)</span></label>
                                        <div class="inline-flex items-center gap-1 bg-white rounded-full p-1 shadow-sm border mt-2">
                                            <button type="button" class="quantity-btn h-8 w-8 text-lg rounded-full a-focus hover:bg-slate-100" data-field="duration" data-amount="-1" aria-label="Decrease duration">-</button>
                                            <div id="duration-count" class="px-2 font-semibold w-8 text-center">1</div>
                                            <button type="button" class="quantity-btn h-8 w-8 text-lg rounded-full a-focus hover:bg-slate-100" data-field="duration" data-amount="1" aria-label="Increase duration">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="commercial-message" class="hidden mt-6 text-center text-slate-600 bg-blue-50 p-4 rounded-lg border border-blue-200">
                           For commercial quotes, please proceed to the next step to provide your contact details. Our team will contact you for a detailed consultation.
                        </div>

                        <div id="step2-error" class="hidden text-red-600 text-sm font-medium mt-4 text-center p-3 bg-red-50 border border-red-200 rounded-lg"></div>

                        <div class="mt-8 flex items-center justify-between">
                            <button type="button" class="btn btn-secondary" data-action="prev" data-translate="back-btn">Back</button>
                            <button type="button" class="btn btn-primary" data-action="next" data-translate="next-btn">Next <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                    </form>

                    <!-- STEP 3: Details -->
                    <form class="step hidden-right" data-step="3">
                        <h3 class="text-2xl font-poppins font-bold text-slate-800" data-translate="details-title">Your Details</h3>
                        <p class="text-slate-500 mt-1" data-translate="details-desc">We need your contact and address for the booking.</p>
                        <div class="mt-6 grid sm:grid-cols-2 gap-5">
                            <div class="field">
                                <select id="salutation" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300">
                                    <option>Mr.</option><option>Ms.</option><option>Mrs.</option>
                                </select>
                                <label for="salutation" data-translate="salutation-label">Salutation</label>
                            </div>
                            <div class="field">
                                <i class="field-icon fas fa-user"></i>
                                <input id="customer-name" type="text" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" " required>
                                <label for="customer-name" data-translate="name-label">Full name</label>
                                <i class="validation-icon fas fa-check-circle success"></i>
                                <i class="validation-icon fas fa-exclamation-circle error"></i>
                                <div class="error-message">Name is required.</div>
                                <div class="success-message">Name looks good!</div>
                            </div>
                            <div class="field">
                                <i class="field-icon fas fa-envelope"></i>
                                <input id="customer-email" type="email" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" " required>
                                <label for="customer-email" data-translate="email-label">Email address</label>
                                <i class="validation-icon fas fa-check-circle success"></i>
                                <i class="validation-icon fas fa-exclamation-circle error"></i>
                                <div class="error-message">A valid email is required.</div>
                                <div class="success-message">Email looks good!</div>
                            </div>
                             <div class="field">
                                <i class="field-icon fas fa-phone"></i>
                                <input id="customer-phone" type="tel" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" " required>
                                <label for="customer-phone" data-translate="phone-label">Phone number</label>
                                <i class="validation-icon fas fa-check-circle success"></i>
                                <i class="validation-icon fas fa-exclamation-circle error"></i>
                                <div class="error-message">Phone number is required.</div>
                                <div class="success-message">Phone number looks good!</div>
                            </div>
                            <div class="field sm:col-span-2">
                                <i class="field-icon fas fa-map-marker-alt"></i>
                                <input id="customer-address" type="text" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" " required>
                                <label for="customer-address" data-translate="address-label">Street address</label>
                                <div class="error-message">Address is required.</div>
                            </div>
                            <div class="field">
                                <i class="field-icon fas fa-hashtag"></i>
                                <input id="postal-code" type="text" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" " required>
                                <label for="postal-code" data-translate="postal-label">Postal Code</label>
                                <div class="error-message">Postal code is required.</div>
                            </div>
                            <div class="field">
                                <i class="field-icon fas fa-city"></i>
                                <input id="city" type="text" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" " required>
                                <label for="city" data-translate="city-label">City</label>
                                <div class="error-message">City is required.</div>
                            </div>
                             <div class="sm:col-span-2">
                                <div class="field">
                                    <i class="field-icon fas fa-comment-dots"></i>
                                    <textarea id="special-requests" rows="2" class="form-input w-full bg-white rounded-lg px-4 pt-6 pb-2 border-gray-300" placeholder=" "></textarea>
                                    <label for="special-requests" data-translate="requests-label">Special requests (optional)</label>
                                </div>
                                <p class="text-xs text-slate-500 mt-1 pl-2">If you've booked less than the recommended time, please list your priority areas here.</p>
                             </div>
                        </div>
                        <div class="mt-8 flex items-center justify-between">
                             <button type="button" class="btn btn-secondary" data-action="prev">Back</button>
                            <button type="button" class="btn btn-accent" data-action="next">Review & Pay</button>
                        </div>
                    </form>
                    
                    <!-- STEP 4: PAYMENT -->
                    <form id="payment-form" class="step hidden-right" data-step="4">
                        <h3 class="text-2xl font-poppins font-bold text-slate-800" data-translate="payment-title">Confirm & Pay</h3>
                        <p class="text-slate-500 mt-1" data-translate="payment-desc">Please review your booking and enter payment details.</p>
                        
                        <div class="mt-6 space-y-3" id="review-container">
                           <!-- JS injects review details -->
                        </div>

                        <!-- Stripe Payment Element -->
                        <div id="payment-element" class="mt-6"></div>
                        <div id="payment-message" class="hidden text-red-600 text-sm font-medium mt-4 text-center p-3 bg-red-50 border border-red-200 rounded-lg"></div>

                        <div class="mt-8 flex items-center justify-between">
                            <button type="button" class="btn btn-secondary" data-action="prev">Go Back</button>
                            <button id="submit-payment" class="btn btn-primary inline-flex items-center gap-3">
                                <span id="button-text" data-translate="book-btn">Pay Now</span>
                                <span id="spinner" class="loader hidden"></span>
                            </button>
                        </div>
                    </form>


                    <!-- STEP 5: Success -->
                    <section class="step hidden-right text-center" data-step="5">
                         <div class="success-checkmark">
                            <div class="check-icon">
                                <span class="icon-line line-tip"></span>
                                <span class="icon-line line-long"></span>
                                <div class="icon-circle"></div>
                                <div class="icon-fix"></div>
                            </div>
                        </div>
                        <h3 class="text-2xl font-poppins font-bold text-slate-800 mt-4">Booking Confirmed!</h3>
                        <p class="text-slate-500 mt-2 max-w-md mx-auto">Thank you, <span id="confirm-name" class="font-semibold"></span>! We've received your request and a confirmation email has been sent to <span id="confirm-email" class="font-semibold"></span>.</p>
                        <p class="text-sm text-slate-500 mt-1">Our team will be at your address on <span id="confirm-date" class="font-semibold"></span>.</p>
                        
                        <!-- Progress Management -->
                        <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-sm text-green-700 mb-3">
                                <i class="fas fa-check-circle mr-2"></i>
                                Your booking progress has been automatically saved and cleared.
                            </p>
                            <button id="clear-progress" class="text-xs text-green-600 hover:text-green-800 underline">
                                Clear all saved data
                            </button>
                        </div>
                        
                        <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
                            <button id="book-another" class="btn btn-primary">
                                <i class="fas fa-plus mr-2"></i>Book Another Cleaning
                            </button>
                            <button id="view-booking" class="btn btn-secondary">
                                <i class="fas fa-eye mr-2"></i>View Booking Details
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- RIGHT: sticky summary -->
        <aside class="lg:sticky lg:top-6 space-y-6">
            <div class="summary-container bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h4 class="text-lg font-poppins font-semibold text-slate-800 border-b pb-3">Booking Summary</h4>
                <div class="mt-4 space-y-3 text-sm" id="summary-container">
                    <!-- JS injects summary -->
                </div>
                <div class="mt-4 border-t pt-4">
                    <div class="flex justify-between items-center">
                        <div class="text-slate-600">Estimated total</div>
                        <div id="summary-total" class="text-2xl font-bold text-blue-600">€0.00</div>
                    </div>
                </div>
                <div class="mt-4 text-xs text-slate-500 text-center">By booking you agree to our <a href="#" class="terms-link text-blue-600 underline">terms</a>.</div>
            </div>
            <!-- Trust Badges -->
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                 <div class="space-y-4">
                    <div class="flex items-center gap-4">
                        <i class="fas fa-shield-halved text-3xl text-accent-500"></i>
                        <div>
                            <h5 class="font-semibold text-slate-800">100% Satisfaction Guarantee</h5>
                            <p class="text-xs text-slate-500">If you're not happy, we'll work to make it right.</p>
                        </div>
                    </div>
                     <div class="flex items-center gap-4">
                        <i class="fas fa-user-check text-3xl text-accent-500"></i>
                        <div>
                            <h5 class="font-semibold text-slate-800">Trusted & Vetted Cleaners</h5>
                            <p class="text-xs text-slate-500">All our professionals are background-checked and trained.</p>
                        </div>
                    </div>
                 </div>
            </div>
        </aside>
    </main>

    <footer class="bg-slate-800 text-slate-300 mt-16">
        <div class="max-w-7xl mx-auto px-6 py-12">
            <div class="grid md:grid-cols-3 gap-8">
                <div class="md:col-span-1">
                     <h4 class="font-poppins font-bold text-white text-lg">AJK Cleaning</h4>
                     <p class="text-sm mt-2 text-slate-400">Your trusted partner for professional cleaning services in Bischofsheim. We are committed to delivering spotless results and exceptional customer service for homes and businesses.</p>
                </div>
                <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-8">
                    <div>
                        <h5 class="font-semibold text-slate-200">Services</h5>
                        <ul class="mt-3 space-y-2 text-sm">
                            <li><a href="#" class="hover:text-white">Residential Cleaning</a></li>
                            <li><a href="#" class="hover:text-white">Deep Cleaning</a></li>
                            <li><a href="#" class="hover:text-white">Move-In/Out</a></li>
                            <li><a href="#" class="hover:text-white">Commercial</a></li>
                        </ul>
                    </div>
                    <div>
                        <h5 class="font-semibold text-slate-200">Legal</h5>
                        <ul class="mt-3 space-y-2 text-sm">
                            <li><a href="#" class="terms-link hover:text-white">Terms of Service</a></li>
                            <li><a href="#" class="privacy-link hover:text-white">Privacy Policy</a></li>
                        </ul>
                    </div>
                     <div>
                        <h5 class="font-semibold text-slate-200">Contact</h5>
                        <ul class="mt-3 space-y-2 text-sm">
                            <li><a href="mailto:info@ajkcleaners.de" class="hover:text-white">info@ajkcleaners.de</a></li>
                            <li><a href="tel:+4917661852286" class="hover:text-white">+49 176 61852286</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 flex flex-col sm:flex-row items-center justify-between text-sm">
                <div>&copy; <span id="year"></span> AJK Cleaning Company. All rights reserved.</div>
                <div class="flex items-center gap-4 mt-4 sm:mt-0 text-lg">
                    <a href="#" aria-label="facebook" class="hover:text-white a-focus"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="instagram" class="hover:text-white a-focus"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </footer>
</div>

<!-- Terms Modal -->
<div id="terms-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-xl font-poppins font-bold text-slate-800">Terms of Service</h3>
            <button id="close-modal-btn" class="text-slate-400 hover:text-slate-800 a-focus rounded-full w-8 h-8 flex items-center justify-center">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto text-slate-600 text-sm">
            <p>Welcome to AJK Cleaning. By booking our services, you agree to the following terms and conditions.</p>
            <h4 class="font-bold text-slate-700 pt-2">1. Booking and Confirmation</h4>
            <p>All bookings are subject to availability. You must provide accurate and complete information during the booking process. Your booking is confirmed only after you receive a confirmation email from us.</p>
            <h4 class="font-bold text-slate-700 pt-2">2. Cancellation Policy</h4>
            <p>Cancellations made at least 48 hours before the scheduled service time will receive a full refund. Cancellations made within 48 hours of the service time may be subject to a cancellation fee.</p>
            <h4 class="font-bold text-slate-700 pt-2">3. Satisfaction Guarantee & Refund Policy</h4>
            <p>We are committed to providing an exceptional cleaning service. If you are not satisfied with the quality of our work, please contact us within 24 hours of the service completion. In cases where our service fails to provide the expected and agreed-upon results, clients are eligible for a partial or full refund.</p>
            <p class="font-medium text-slate-700">To claim a refund, please contact AJK Cleaning with all the necessary proof, such as your invoice, booking confirmation messages, and photographic evidence of the issues. You can reach our support team at:</p>
            <ul class="list-disc list-inside bg-slate-50 p-3 rounded-lg border">
                <li>Email: <a href="mailto:info@ajkcleaners.de" class="text-blue-600 font-semibold">info@ajkcleaners.de</a></li>
                <li>Phone: <a href="tel:+491629817752" class="text-blue-600 font-semibold">+49 162 9817752</a></li>
            </ul>
            <p>Our team will review your claim and process it accordingly. All decisions regarding refunds are at the discretion of AJK Cleaning management.</p>
            <h4 class="font-bold text-slate-700 pt-2">4. Liability</h4>
            <p>AJK Cleaning is insured and bonded. While we exercise the utmost care in cleaning your property, we are not liable for pre-existing damage, wear and tear, or damage resulting from improper installation of any item.</p>
        </div>
        <div class="p-4 bg-slate-50 border-t text-right rounded-b-2xl">
            <button id="modal-close-footer" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Privacy Policy Modal -->
<div id="privacy-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-xl font-poppins font-bold text-slate-800">Privacy Policy</h3>
            <button id="close-privacy-modal-btn" class="text-slate-400 hover:text-slate-800 a-focus rounded-full w-8 h-8 flex items-center justify-center">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto text-slate-600 text-sm">
            <p><strong>Last Updated:</strong> October 1, 2025</p>
            <p>AJK Cleaning ("we," "our," or "us") is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our booking services.</p>
            <h4 class="font-bold text-slate-700 pt-2">1. Information We Collect</h4>
            <p>We may collect personal information that you provide directly to us, such as your name, salutation, email address, phone number, and physical address when you book a cleaning service.</p>
            <h4 class="font-bold text-slate-700 pt-2">2. How We Use Your Information</h4>
            <p>We use the information we collect to:</p>
            <ul class="list-disc list-inside pl-4">
                <li>Schedule, confirm, and provide our cleaning services.</li>
                <li>Communicate with you about your booking, including reminders and updates.</li>
                <li>Process payments for our services.</li>
                <li>Respond to your comments, questions, and requests.</li>
                <li>Improve our website and services.</li>
            </ul>
            <h4 class="font-bold text-slate-700 pt-2">3. Data Sharing and Disclosure</h4>
            <p>We do not sell, trade, or otherwise transfer your personally identifiable information to outside parties. This does not include trusted third parties who assist us in operating our website, conducting our business (such as payment processors), or servicing you, so long as those parties agree to keep this information confidential. Your information will be shared with our cleaning staff solely for the purpose of providing the service at your specified address.</p>
            <h4 class="font-bold text-slate-700 pt-2">4. Data Security</h4>
            <p>We implement a variety of security measures to maintain the safety of your personal information when you place an order. However, no electronic transmission over the internet or information storage technology can be guaranteed to be 100% secure.</p>
            <h4 class="font-bold text-slate-700 pt-2">5. Your Rights</h4>
            <p>You have the right to request access to, correct, or delete your personal data. To make such a request, please contact us using the information below.</p>
            <h4 class="font-bold text-slate-700 pt-2">6. Contact Us</h4>
            <p>If you have any questions regarding this privacy policy, you may contact us using the information below:</p>
            <ul class="list-disc list-inside bg-slate-50 p-3 rounded-lg border">
                 <li>Email: <a href="mailto:info@ajkcleaners.de" class="text-blue-600 font-semibold">info@ajkcleaners.de</a></li>
                <li>Phone: <a href="tel:+4917661852286" class="text-blue-600 font-semibold">+49 176 61852286</a></li>
            </ul>
        </div>
        <div class="p-4 bg-slate-50 border-t text-right rounded-b-2xl">
            <button id="privacy-modal-close-footer" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Loading Screen -->
<div id="loading-screen" class="loading-screen">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
        </div>
        <h3 class="loading-title">Processing Payment...</h3>
        <p class="loading-subtitle">Please don't close this window</p>
        <div class="loading-progress">
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('📄 SCRIPT TAG LOADED - JavaScript file is being processed');

// Test if basic JavaScript is working
console.log('🔧 Basic JavaScript test:', typeof document, typeof window);

try {
document.addEventListener('DOMContentLoaded', async () => {
    console.log('🚀 BOOKING PAGE LOADED - JavaScript is running!');
    console.log('🔍 DOM elements check:');
    console.log('  - Payment form:', document.getElementById('payment-form'));
    console.log('  - Submit button:', document.getElementById('submit-payment'));
    console.log('  - Wizard:', document.getElementById('wizard'));
    
    // Initialize form validation
    addRealTimeValidation();
    
    // Ensure button starts in correct state (no loading)
    setLoading(false);
    
    // Disable payment button initially until form is ready
    const submitBtn = document.getElementById('submit-payment');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Loading Payment Form...';
        console.log('🔒 Payment button disabled - waiting for form to load');
    }
    
    let stripe;
    try {
        const response = await fetch('/api/stripe-key');
        const { publishableKey } = await response.json();
        stripe = Stripe(publishableKey);
        console.log('✅ Stripe initialized with key:', publishableKey.substring(0, 20) + '...');
        console.log('🔍 Stripe key type:', publishableKey.startsWith('pk_live_') ? 'LIVE' : 'TEST');
    } catch (error) {
        console.error('❌ Failed to load Stripe key:', error);
        stripe = Stripe('pk_test_51SD6iOHIVAzPWFkU1ixyvux7u4Srneo6y2tuko22UX4OR2cGTNXvAssP1DAhbB9XnSDOgNPAwpOaLchXBBRD36Fb00uYOldQMJ');
    }
    
    // --- Stripe variables ---
    let elements;
    let paymentElement;

        // --- FORM VALIDATION ---
        function validateForm() {
            console.log('🔍 Starting form validation...');
            const requiredFields = [
                'customer-name',
                'customer-email', 
                'customer-phone',
                'customer-address',
                'postal-code',
                'city'
            ];
            
            let isValid = true;
            
            // Clear previous error states
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorMessage = field.parentElement.querySelector('.error-message');
                if (field && errorMessage) {
                    field.classList.remove('error');
                    errorMessage.style.display = 'none';
                }
            });
            
            // Validate each required field
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorMessage = field.parentElement.querySelector('.error-message');
                
                console.log(`🔍 Validating field ${fieldId}:`, field ? field.value : 'FIELD NOT FOUND');
                
                if (!field || !field.value.trim()) {
                    console.log(`❌ Field ${fieldId} is empty or missing`);
                    if (field) {
                        field.classList.add('error');
                        if (errorMessage) {
                            errorMessage.style.display = 'block';
                        }
                    }
                    isValid = false;
                }
            });
            
            // Validate email format
            const emailField = document.getElementById('customer-email');
            const emailError = emailField.parentElement.querySelector('.error-message');
            if (emailField.value.trim() && !isValidEmail(emailField.value)) {
                emailField.classList.add('error');
                if (emailError) {
                    emailError.textContent = 'Please enter a valid email address.';
                    emailError.style.display = 'block';
                }
                isValid = false;
            }
            
            console.log('🔍 Form validation complete. Result:', isValid);
            return isValid;
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Add real-time validation to clear errors when user starts typing (with debouncing)
        function addRealTimeValidation() {
            const requiredFields = [
                'customer-name',
                'customer-email', 
                'customer-phone',
                'customer-address',
                'postal-code',
                'city'
            ];
            
            // Debounce function to limit validation frequency
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            const debouncedValidation = debounce(function(field) {
                if (field.value.trim()) {
                    field.classList.remove('error');
                    const errorMessage = field.parentElement.querySelector('.error-message');
                    if (errorMessage) {
                        errorMessage.style.display = 'none';
                    }
                }
            }, 300); // 300ms debounce
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        debouncedValidation(this);
                    });
                }
            });
        }
        
        // Loading screen functions
        function showLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('show');
                document.body.style.overflow = 'hidden'; // Prevent scrolling
            }
        }
        
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.remove('show');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // --- CONFIGURATION ---
        const CONFIG = {
        packages: {
            'one-time': [
                { id: 'basic', title: 'Basic Cleaning (Residential)', price: 28, desc: 'Standard residential cleaning service.', icon: 'fas fa-home', hourly: true },
                { id: 'deep', title: 'Deep Cleaning', price: 35, desc: 'Intensive service for a home that feels brand new.', icon: 'fas fa-broom', hourly: true },
                { id: 'moveout', title: 'Move In/Out Cleaning', price: 37, desc: 'A top-to-bottom clean for an empty home.', icon: 'fas fa-box-open', hourly: true },
            ],
            'subscription': [
                { id: 'regular-basic', title: 'Regular Basic Cleaning', price: 0, desc: 'Ongoing residential cleaning service with flexible pricing after consultation.', icon: 'fas fa-home', flexible: true },
                { id: 'commercial', title: 'Commercial Cleaning', price: 0, desc: 'Tailored solutions for your office or retail space.', icon: 'fas fa-building', flexible: true },
            ]
        },
        limits: {
            cleaners: { min: 1, max: 5 },
            duration: { min: 1, max: 12 },
        },
        timeSlots: [
            // Morning slots: 8:00 AM to 10:00 AM (30-minute intervals)
            "08:00", "08:30", "09:00", "09:30", "10:00",
            // Afternoon slots: 12:00 PM to 6:00 PM (30-minute intervals)
            "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", 
            "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00"
        ]
    };

    // --- DOM ELEMENTS CACHE ---
    const DOM = {
        wizard: document.getElementById('wizard'),
        steps: Array.from(document.querySelectorAll('.step')),
        wizardSteps: Array.from(document.querySelectorAll('.wizard-step')),
        packageContainer: document.getElementById('package-selection'),
        summaryContainer: document.getElementById('summary-container'),
        reviewContainer: document.getElementById('review-container'),
        summaryTotal: document.getElementById('summary-total'),
        year: document.getElementById('year'),
        calendar: {
            grid: document.getElementById('calendar-grid'),
            monthYear: document.getElementById('month-year'),
            prevBtn: document.getElementById('prev-month'),
            nextBtn: document.getElementById('next-month'),
        },
        durationSuggestion: document.getElementById('duration-suggestion'),
        timeSlotsContainer: document.getElementById('time-slots'),
        termsModal: document.getElementById('terms-modal'),
        privacyModal: document.getElementById('privacy-modal'),
        paymentForm: document.getElementById('payment-form'),
    };

    // --- STATE MANAGEMENT ---
    let state = {
        activeStep: 0,
        bookingType: 'one-time',
        package: 'basic',
        price_per_hour: 28,
        cleaners: 1,
        duration: 1,
        date: '',
        time: '',
        propertySize: '',
        salutation: 'Mr.',
        customerName: '',
        customerEmail: '',
        customerPhone: '',
        customerAddress: '',
        city: '',
        postalCode: '',
        specialRequests: '',
    };
    
    const today = new Date();
    today.setHours(0, 0, 0, 0); 
    const limitDate = new Date();
    limitDate.setDate(today.getDate() + 45);
    limitDate.setHours(23, 59, 59, 999);

    let currentDate = new Date();
    currentDate.setDate(1);

    // --- INITIALIZATION ---
    function init() {
        DOM.year.textContent = new Date().getFullYear();
        
        // Try to load saved progress first
        const hasProgress = loadProgress();
        
        renderPackages();
        setupEventListeners();
        renderCalendar();
        renderTimeSlots();
        updateUI();
        
        // Setup real-time validation
        setupRealTimeValidation();
        
        // Show appropriate step (saved progress or step 0)
        showStep(hasProgress ? state.activeStep : 0);
        
        // If we loaded progress, populate the form fields
        if (hasProgress) {
            populateFormFields();
        } else {
            selectPackage(document.querySelector('.package'));
        }
        
        checkStripeStatus();
        setupLanguageSwitcher();
        
        // Set initial booking type selection
        document.querySelector('.booking-type-card[data-booking-type="one-time"]').classList.add('selected');
        
        // Show progress restoration message if applicable
        if (hasProgress) {
            showMessage('Your previous booking progress has been restored. You can continue where you left off.', 'info');
        }
    }
    
    // --- POPULATE FORM FIELDS FROM SAVED STATE ---
    function populateFormFields() {
        const fields = [
            'customer-name', 'customer-email', 'customer-phone', 
            'customer-address', 'postal-code', 'city', 'property-size'
        ];
        
        fields.forEach(fieldId => {
            const input = document.getElementById(fieldId);
            if (input && state[fieldId.replace('customer-', '').replace('-', '')]) {
                input.value = state[fieldId.replace('customer-', '').replace('-', '')];
                // Trigger validation to update UI
                validateField(input);
            }
        });
        
        // Update other form elements
        if (state.salutation) {
            const salutationSelect = document.getElementById('salutation');
            if (salutationSelect) salutationSelect.value = state.salutation;
        }
    }

    // --- RENDER FUNCTIONS ---
    function renderPackages() {
        const packages = CONFIG.packages[state.bookingType] || CONFIG.packages['one-time'];
        DOM.packageContainer.innerHTML = packages.map(p => {
            let priceDisplay = '';
            let priceColor = 'text-blue-600';
            let priceBg = 'bg-blue-50';
            
            if (p.flexible) {
                priceDisplay = 'Flexible Rate';
                priceColor = 'text-orange-600';
                priceBg = 'bg-orange-50';
            } else if (p.hourly) {
                priceDisplay = `€${p.price}/hour`;
                priceColor = 'text-green-600';
                priceBg = 'bg-green-50';
            } else {
                priceDisplay = `€${p.price}`;
                priceColor = 'text-blue-600';
                priceBg = 'bg-blue-50';
            }
            
            return `
                <label class="package card-hover bg-white p-6 rounded-2xl cursor-pointer a-focus border border-slate-200 shadow-sm hover:shadow-lg transition-all duration-300" tabindex="0" data-package-id="${p.id}">
                    <input type="radio" name="package" value="${p.id}" class="sr-only" ${p.id === state.package ? 'checked' : ''}>
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 ${priceBg} rounded-xl flex items-center justify-center">
                                <i class="${p.icon} text-lg ${priceColor}"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">${p.title}</h4>
                                <p class="text-sm text-slate-500 mt-1">${p.desc}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${priceColor} text-xl">${priceDisplay}</div>
                            ${p.hourly ? '<div class="text-xs text-slate-400 mt-1">per hour</div>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <i class="fas fa-check-circle"></i>
                        <span>${p.flexible ? 'Custom quote provided' : p.hourly ? 'Flexible duration' : 'Fixed price service'}</span>
                    </div>
                </label>
            `;
        }).join('');
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        DOM.calendar.monthYear.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
        DOM.calendar.grid.innerHTML = '';
        
        DOM.calendar.prevBtn.disabled = (year === today.getFullYear() && month === today.getMonth());
        const nextMonthFirstDay = new Date(year, month + 1, 1);
        DOM.calendar.nextBtn.disabled = nextMonthFirstDay > limitDate;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayOffset = (firstDay === 0) ? 6 : firstDay - 1;

        for (let i = 0; i < dayOffset; i++) DOM.calendar.grid.insertAdjacentHTML('beforeend', '<div></div>');

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            date.setHours(0,0,0,0);
            const isDisabled = date < today || date > limitDate;
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isSelected = dateStr === state.date;
            DOM.calendar.grid.insertAdjacentHTML('beforeend', `<button type="button" class="day p-2 rounded-full aspect-square ${isDisabled ? 'disabled text-slate-300 cursor-not-allowed' : 'a-focus'} ${isSelected ? 'selected' : ''}" data-date="${dateStr}" ${isDisabled ? 'disabled' : ''}>${day}</button>`);
        }
    }

    function renderTimeSlots() {
        DOM.timeSlotsContainer.innerHTML = CONFIG.timeSlots.map(time => `<button type="button" class="time-slot p-2 rounded-lg border text-sm font-medium transition-colors a-focus ${state.time === time ? 'selected' : ''}" data-time="${time}">${time}</button>`).join('');
    }

    function formatMinutesToHours(totalMinutes) {
        if (totalMinutes <= 0) return '0min';
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        let result = '';
        if (hours > 0) result += `${hours}h`;
        if (minutes > 0) { if (hours > 0) result += ' '; result += `${minutes}min`; }
        return result;
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        DOM.wizard.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            if (button.dataset.action === 'next') { 
                if(validateStep(state.activeStep)) { 
                    // Check if this is commercial booking going from step 2 to step 3
                    if (state.activeStep === 2) {
                        const packages = CONFIG.packages[state.bookingType];
                        const pkg = packages.find(p => p.id === state.package);
                        const isCommercial = pkg.id === 'commercial' || pkg.flexible;
                        
                        if (isCommercial) {
                            // For commercial bookings, skip payment step and go directly to success
                            console.log('📞 Commercial booking - skipping payment step, submitting booking');
                            submitCommercialBooking(); // Submit booking and show success
                        } else {
                            showStep(state.activeStep + 1); // Normal flow to payment step
                        }
                    } else {
                        showStep(state.activeStep + 1); // Normal flow for other steps
                    }
                } 
            }
            if (button.dataset.action === 'prev') { showStep(state.activeStep - 1); }
            const editStep = button.dataset.editStep;
            if (editStep) { showStep(parseInt(editStep) - 1); }
            if(button.id === 'book-another') { window.location.replace(window.location.pathname); }
        });

        // Add click listener to payment button for debugging
        const submitBtn = document.getElementById('submit-payment');
        if (submitBtn) {
            submitBtn.addEventListener('click', (e) => {
                console.log('🔍 Payment button clicked!');
                console.log('🔍 Button disabled state:', submitBtn.disabled);
                console.log('🔍 Button text:', submitBtn.textContent);
            });
        }
        
        // Add event listeners for success step buttons
        const clearProgressBtn = document.getElementById('clear-progress');
        if (clearProgressBtn) {
            clearProgressBtn.addEventListener('click', () => {
                clearProgress();
                showMessage('All saved data has been cleared.', 'success');
            });
        }
        
        const viewBookingBtn = document.getElementById('view-booking');
        if (viewBookingBtn) {
            viewBookingBtn.addEventListener('click', () => {
                // Show booking details in a modal or redirect to booking management
                showBookingDetails();
            });
        }

        DOM.paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('🔍 Payment form submitted, starting validation...');
            console.log('🔍 Event target:', e.target);
            console.log('🔍 Submit button clicked:', e.submitter);
            
            // Validate form fields
            const isValid = validateForm();
            console.log('🔍 Form validation result:', isValid);
            if (!isValid) {
                console.log('❌ Form validation failed, stopping payment');
                return;
            }
            
            const packages = CONFIG.packages[state.bookingType];
            const pkg = packages.find(p => p.id === state.package);
            const isCommercial = pkg.id === 'commercial' || pkg.flexible;
            
            if (isCommercial) {
                // For commercial and flexible services (including regular-basic), submit booking data to server
                await submitCommercialBooking();
                return;
            }
            setLoading(true);
            
            // Add a global timeout to prevent infinite buffering
            const globalTimeout = setTimeout(() => {
                console.error('❌ Payment processing timeout - proceeding anyway');
                setLoading(false);
                showStep(4);
            }, 15000); // 15 second global timeout (reduced from 30s)
            
            try {

            // Check if payment element is properly mounted and visible
            if (!paymentElement || !elements) {
                throw new Error('Payment element not properly initialized');
            }

            // Ensure payment element is visible and ready
            const paymentElementContainer = document.getElementById('payment-element');
            if (!paymentElementContainer || paymentElementContainer.children.length === 0) {
                throw new Error('Payment form not loaded. Please wait and try again.');
            }

            // Critical: Check if payment form is actually interactive and user has entered data
            const paymentInputs = paymentElementContainer.querySelectorAll('input, iframe');
            if (paymentInputs.length === 0) {
                throw new Error('Payment form is not ready. Please wait for the form to load completely.');
            }

            // Check if Stripe elements are in a ready state (simplified check)
            if (!paymentElement || paymentElement._componentName !== 'payment') {
                console.warn('⚠️ Payment element not ready, proceeding anyway...');
                // Don't throw error, just proceed with payment
            }

            console.log('✅ Payment element is ready, validating user input...');

            // Simplified validation - just check if elements exist and proceed
            console.log('✅ Payment element is ready, proceeding with payment confirmation...');

            // Add timeout to payment confirmation
            const paymentPromise = stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.href.split('?')[0],
                },
                redirect: 'if_required' // Prevent redirect for successful payment
            });
            
            // Add timeout to prevent hanging
            const paymentTimeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Payment confirmation timeout')), 10000)
            );
            
            const { error, paymentIntent } = await Promise.race([paymentPromise, paymentTimeout]);
            
            console.log('🔍 Payment confirmation result:', { error, paymentIntent });

            if (error) {
                clearTimeout(globalTimeout);
                console.error('❌ Payment error:', error);
                
                if (error.message === 'Payment confirmation timeout') {
                    showMessage("Payment is taking too long. Please try again.");
                } else if (error.type === "card_error" || error.type === "validation_error") {
                    showMessage(`Payment error: ${error.message}`);
                } else {
                    showMessage("Payment failed. Please check your card details and try again.");
                }
                setLoading(false);
            } else {
                // Payment succeeded - wait a moment for webhook to process
                console.log('✅ Payment successful, waiting for booking creation...');
                console.log('🔍 Payment Intent details:', paymentIntent);
                
                // Show user-friendly message
                showMessage('Payment successful! Creating your booking...');
                
                // Wait for booking to be created by webhook, with fallback
                let attempts = 0;
                const maxAttempts = 8; // Reduced from 10 to 8 for faster fallback
                const checkBooking = async () => {
                    try {
                        console.log(`🔍 Checking for booking creation (attempt ${attempts + 1}/${maxAttempts})...`);
                        
                        // First verify payment status
                        const paymentStatusResponse = await fetch(`/api/bookings/check-payment-status/${state.paymentIntentId}`);
                        if (!paymentStatusResponse.ok) {
                            throw new Error('Payment verification failed');
                        }
                        
                        const paymentStatus = await paymentStatusResponse.json();
                        if (paymentStatus.status !== 'paid' && paymentStatus.status !== 'succeeded') {
                            throw new Error(`Payment not successful. Status: ${paymentStatus.status}`);
                        }
                        
                        const response = await fetch(`/api/bookings/by-payment-intent/${state.paymentIntentId}`);
                        
                        if (response.ok) {
                            const booking = await response.json();
                            if (booking && booking.id) {
                                console.log('✅ Booking created successfully:', booking.id);
                                clearTimeout(globalTimeout);
                                setLoading(false);
                                showStep(4);
                                return;
                            }
                        } else if (response.status === 404) {
                            console.log('⏳ Booking not found yet, waiting for webhook...');
                        } else {
                            console.warn('⚠️ Unexpected response from booking check:', response.status);
                        }
                        
                        // If webhook is taking too long, try to create booking manually
                        if (attempts >= 3) {
                            console.log('🔄 Webhook taking too long, trying manual booking creation...');
                            try {
                                const createResponse = await fetch('/api/bookings/create-from-payment', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ paymentIntentId: state.paymentIntentId })
                                });
                                
                                if (createResponse.ok) {
                                    const createResult = await createResponse.json();
                                    console.log('✅ Manual booking creation successful:', createResult.booking?.id);
                                    clearTimeout(globalTimeout);
                                    setLoading(false);
                                    showStep(4);
                                    return;
                                } else {
                                    console.warn('⚠️ Manual booking creation failed:', createResponse.status);
                                }
                            } catch (createError) {
                                console.error('❌ Manual booking creation error:', createError);
                            }
                        }
                        
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(checkBooking, 1500); // Check again in 1.5 seconds
                        } else {
                            // Fallback: create booking manually
                            console.log('🔄 Webhook timeout, creating booking manually...');
                            setLoading(true);
                            try {
                                // First verify payment status with Stripe
                                console.log('🔍 Verifying payment status before creating booking...');
                                const paymentStatusResponse = await fetch(`/api/bookings/check-payment-status/${state.paymentIntentId}`);
                                
                                if (!paymentStatusResponse.ok) {
                                    throw new Error('Payment verification failed');
                                }
                                
                                const paymentStatus = await paymentStatusResponse.json();
                                console.log('📊 Payment status:', paymentStatus);
                                
                                if (paymentStatus.status !== 'succeeded') {
                                    throw new Error(`Payment not successful. Status: ${paymentStatus.status}`);
                                }
                                
                                const createResponse = await fetch('/api/bookings/create-from-payment', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ paymentIntentId: state.paymentIntentId })
                                });
                                
                                if (createResponse.ok) {
                                    const result = await createResponse.json();
                                    console.log('✅ Booking created manually:', result.booking.id);
                                    clearTimeout(globalTimeout);
                                    setLoading(false);
                                    showStep(4);
                                } else {
                                    const errorData = await createResponse.json().catch(() => ({}));
                                    console.error('❌ Manual booking creation failed:', errorData);
                                    clearTimeout(globalTimeout);
                                    showMessage('Payment successful but booking creation failed. Please contact support.');
                                    setLoading(false);
                                }
                            } catch (createError) {
                                console.error('❌ Error creating booking manually:', createError);
                                clearTimeout(globalTimeout);
                                showMessage('Payment verification failed. Please contact support if you were charged.');
                                setLoading(false);
                            }
                        }
                    } catch (error) {
                        console.error('❌ Error checking booking creation:', error);
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(checkBooking, 1500);
                        } else {
                            console.error('❌ Max attempts reached, payment verification failed');
                            clearTimeout(globalTimeout);
                            setLoading(false);
                            showMessage('Payment verification failed. Please contact support if you were charged.');
                        }
                    }
                };
                
                // Start checking for booking creation
                setTimeout(checkBooking, 1000); // Wait 1 second before first check
            }
            
            } catch (paymentError) {
                console.error('❌ Payment processing error:', paymentError);
                clearTimeout(globalTimeout);
                setLoading(false);
                
                if (paymentError.message === 'Payment element not properly initialized') {
                    showMessage('Payment form is not ready. Please refresh the page and try again.');
                } else if (paymentError.message === 'Payment form not loaded. Please wait and try again.') {
                    showMessage('Payment form is loading. Please wait a moment and try again.');
                } else if (paymentError.message === 'Payment form is not ready. Please wait for the form to load completely.') {
                    showMessage('Payment form is not ready. Please wait for the form to load completely.');
                } else {
                    showMessage('Payment processing failed. Please try again.');
                }
            }
        });

        // Booking type selection
        document.querySelectorAll('input[name="booking-type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.bookingType = e.target.value;
                // Reset package selection when booking type changes
                state.package = CONFIG.packages[state.bookingType][0].id;
                state.price_per_hour = CONFIG.packages[state.bookingType][0].price;
                
                // Add transition animation
                const packageContainer = document.getElementById('package-selection');
                packageContainer.classList.add('package-selection-transition');
                
                renderPackages();
                updateUI();
                
                // Update visual selection
                document.querySelectorAll('.booking-type-card').forEach(card => {
                    card.classList.remove('selected');
                });
                e.target.closest('.booking-type-card').classList.add('selected');
                
                // Remove transition class after animation
                setTimeout(() => {
                    packageContainer.classList.remove('package-selection-transition');
                }, 500);
            });
        });

        DOM.packageContainer.addEventListener('click', e => {
            const card = e.target.closest('.package');
            if (card) selectPackage(card);
        });

        DOM.wizard.addEventListener('click', e => {
            const btn = e.target.closest('.quantity-btn');
            if (btn) {
                const { field, amount } = btn.dataset;
                updateQuantity(field, parseInt(amount));
            }
        });
        
        DOM.wizard.addEventListener('input', e => {
            const { id, value } = e.target;
            const key = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
            if (key in state) {
                state[key] = value;
                if (id === 'property-size') {
                    const sizeInput = e.target;
                    let size = parseInt(value, 10);
                    if (size > 300) { size = 300; sizeInput.value = '300'; state.propertySize = '300'; }

                    const suggestionBox = DOM.durationSuggestion;
                    if (size > 0) {
                        let suggestedDuration = Math.ceil(size / 50);
                        const { min, max } = CONFIG.limits.duration;
                        state.duration = Math.max(min, Math.min(max, suggestedDuration));
                        const baseMinutes = 90, minutesPerSqM = 2, totalMinutes = baseMinutes + (size * minutesPerSqM);
                        const minTime = Math.max(60, totalMinutes - 30), maxTime = totalMinutes + 30;
                        const minTimeStr = formatMinutesToHours(minTime), maxTimeStr = formatMinutesToHours(maxTime);

                        suggestionBox.innerHTML = `<p class="font-semibold">For a property of <strong>${size} m²</strong>, we recommend between <strong>${minTimeStr}</strong> and <strong>${maxTimeStr}</strong>.</p><p class="mt-1">If you book less, please specify priority areas in 'Special Requests' later.</p>`;
                        suggestionBox.classList.remove('hidden');
                    } else {
                        state.duration = CONFIG.limits.duration.min;
                        suggestionBox.classList.add('hidden');
                    }
                    updateUI();
                }
            }
        });

        DOM.calendar.prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        DOM.calendar.nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        DOM.calendar.grid.addEventListener('click', e => {
            const dayBtn = e.target.closest('.day');
            if (dayBtn && !dayBtn.disabled) { state.date = dayBtn.dataset.date; renderCalendar(); updateUI(); }
        });
        DOM.timeSlotsContainer.addEventListener('click', e => {
            const timeBtn = e.target.closest('.time-slot');
            if(timeBtn) { state.time = timeBtn.dataset.time; renderTimeSlots(); updateUI(); }
        });

        document.querySelectorAll('.terms-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); DOM.termsModal.classList.remove('hidden'); DOM.termsModal.classList.add('flex'); }); });
        const closeModal = () => { DOM.termsModal.classList.add('hidden'); DOM.termsModal.classList.remove('flex'); };
        DOM.termsModal.addEventListener('click', (e) => { if (e.target === DOM.termsModal) closeModal(); });
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        document.getElementById('modal-close-footer').addEventListener('click', closeModal);

        document.querySelectorAll('.privacy-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); DOM.privacyModal.classList.remove('hidden'); DOM.privacyModal.classList.add('flex'); }); });
        const closePrivacyModal = () => { DOM.privacyModal.classList.add('hidden'); DOM.privacyModal.classList.remove('flex'); };
        DOM.privacyModal.addEventListener('click', (e) => { if (e.target === DOM.privacyModal) closePrivacyModal(); });
        document.getElementById('close-privacy-modal-btn').addEventListener('click', closePrivacyModal);
        document.getElementById('privacy-modal-close-footer').addEventListener('click', closePrivacyModal);
    }

    // --- ACTIONS ---
    function selectPackage(card) {
        DOM.packageContainer.querySelectorAll('.package').forEach(l => l.classList.remove('selected'));
        card.classList.add('selected');
        const radio = card.querySelector('input');
        radio.checked = true;
        
        const packages = CONFIG.packages[state.bookingType];
        const selectedPkg = packages.find(p => p.id === radio.value);
        state.package = selectedPkg.id;
        state.price_per_hour = selectedPkg.price;

        const scheduleFields = document.getElementById('schedule-fields');
        const commercialMessage = document.getElementById('commercial-message');
        if (selectedPkg.id === 'commercial' || selectedPkg.flexible) {
            scheduleFields.classList.add('hidden');
            commercialMessage.classList.remove('hidden');
        } else {
            scheduleFields.classList.remove('hidden');
            commercialMessage.classList.add('hidden');
        }
        updateUI();
    }
    
    function updateQuantity(field, amount) {
        const limits = CONFIG.limits[field];
        const newValue = state[field] + amount;
        if (newValue >= limits.min && newValue <= limits.max) {
            state[field] = newValue;
            updateUI();
        }
    }
    
    function showStep(index) {
        if (index < 0 || index >= DOM.steps.length) return;
        state.activeStep = index;
        
        DOM.steps.forEach((s, i) => {
            s.classList.remove('hidden-left', 'hidden-right');
            if (i !== index) { s.classList.add(i < index ? 'hidden-left' : 'hidden-right'); }
        });

        DOM.wizardSteps.forEach((ws, i) => {
            ws.classList.remove('active', 'completed');
            if (i < index) ws.classList.add('completed');
            if (i === index) ws.classList.add('active');
        });
        
        // Clear progress when reaching success step
        if (index === 4) { // Success step
            clearProgress();
            console.log('🎉 Booking completed - progress cleared');
        }
        
        if(index === 3){ // Payment step
            console.log('💳 Showing payment step, package:', state.package);
            const packages = CONFIG.packages[state.bookingType];
            const pkg = packages.find(p => p.id === state.package);
            const isCommercial = pkg.id === 'commercial' || pkg.flexible;
            
            if(isCommercial){
                 // For commercial bookings, skip payment step and go directly to success
                 console.log('📞 Commercial booking - skipping payment, going to success');
                 // Submit commercial booking first, then show success
                 submitCommercialBooking();
                 return;
            } else {
                 document.getElementById('payment-element').style.display = 'block';
                 console.log('💳 Regular booking - showing payment element');
                 // Wait a moment for the step to be fully visible before initializing Stripe
                 setTimeout(() => {
                     initializeStripe();
                 }, 100);
                 
                 // Fallback: Enable payment button after a reasonable timeout
                 setTimeout(() => {
                     const submitBtn = document.getElementById('submit-payment');
                     if (submitBtn && submitBtn.disabled) {
                         console.log('⚠️ Fallback: Enabling payment button after timeout');
                         submitBtn.disabled = false;
                         submitBtn.textContent = 'Pay Now';
                     }
                 }, 5000); // 5 second fallback
            }
        }
        
        if(index === 4){
             document.getElementById('confirm-name').textContent = state.customerName;
             document.getElementById('confirm-email').textContent = state.customerEmail;
             const packages = CONFIG.packages[state.bookingType];
             const pkg = packages.find(p => p.id === state.package);
             const isCommercial = pkg.id === 'commercial' || pkg.flexible;
             document.getElementById('confirm-date').textContent = isCommercial ? 'Our team will contact you shortly' : `${state.date} at ${state.time}`;
        }
        updateUI();
    }

    // --- UI UPDATES ---
    function updateUI() {
        document.getElementById('cleaners-count').textContent = state.cleaners;
        document.getElementById('duration-count').textContent = state.duration;

        const packages = CONFIG.packages[state.bookingType];
        const pkg = packages.find(p => p.id === state.package);
        const isCommercial = pkg.id === 'commercial' || pkg.flexible;
        
        let total = 0;
        if (isCommercial) {
            total = 0;
        } else if (pkg.hourly) {
            // For hourly services, calculate based on duration
            total = state.price_per_hour * state.duration * state.cleaners;
        } else {
            // For fixed price services
            total = state.price_per_hour * state.cleaners;
        }
        
        let summaryDetails = `<div class="flex justify-between items-center"><span class="flex items-center gap-2 text-slate-600"><i class="fas fa-box w-4 text-center text-slate-400"></i>Package</span><strong class="capitalize">${pkg.title}</strong></div>`;
        if (isCommercial) {
            summaryDetails += `<div class="text-center p-3 bg-slate-50 rounded-md my-2">Details will be confirmed after consultation.</div>`;
        } else {
            let rateDisplay = '';
            if (pkg.hourly) {
                rateDisplay = `€${pkg.price}/hour`;
            } else {
                rateDisplay = `€${pkg.price}`;
            }
            
            summaryDetails += `
                <div class="flex justify-between items-center"><span class="flex items-center gap-2 text-slate-600"><i class="fas fa-calendar-alt w-4 text-center text-slate-400"></i>When</span><strong>${state.date && state.time ? `${state.date} at ${state.time}`: 'Not set'}</strong></div>
                <div class="flex justify-between items-center"><span class="flex items-center gap-2 text-slate-600"><i class="fas fa-ruler-combined w-4 text-center text-slate-400"></i>Size</span><strong>${state.propertySize ? `${state.propertySize} m²` : 'N/A'}</strong></div>
                <div class="flex justify-between items-center"><span class="flex items-center gap-2 text-slate-600"><i class="fas fa-hourglass-half w-4 text-center text-slate-400"></i>Duration</span><strong>${state.duration}h</strong></div>
                <div class="flex justify-between items-center"><span class="flex items-center gap-2 text-slate-600"><i class="fas fa-users w-4 text-center text-slate-400"></i>Cleaners</span><strong>${state.cleaners}</strong></div>
                <div class="flex justify-between items-center"><span class="flex items-center gap-2 text-slate-600"><i class="fas fa-tag w-4 text-center text-slate-400"></i>Rate</span><strong>${rateDisplay}</strong></div>`;
        }
        DOM.summaryContainer.innerHTML = summaryDetails;

        DOM.summaryTotal.textContent = isCommercial ? 'On Request' : `€${total.toFixed(2)}`;

        if (state.activeStep === 3) {
            const fullAddress = `${state.customerAddress}, ${state.postalCode} ${state.city}`;
            let reviewDetails = `<div class="p-4 bg-slate-50 rounded-lg border"><div class="flex justify-between items-center"><div class="flex items-center gap-3"><i class="fas fa-user-circle text-xl text-blue-500"></i><div><div class="text-sm text-slate-500">Billed To</div><div class="font-semibold truncate">${state.customerName}</div><div class="text-sm font-medium text-slate-600">${fullAddress}</div></div></div><button type="button" class="text-sm font-semibold text-blue-600 hover:underline a-focus flex-shrink-0 ml-4" data-edit-step="3">Edit</button></div></div>`;
            DOM.reviewContainer.innerHTML = reviewDetails;

            const buttonText = document.getElementById('button-text');
            if (buttonText) buttonText.textContent = isCommercial ? 'Request Quote' : `Pay €${total.toFixed(2)}`;
        }
    }
    
    // --- ENHANCED VALIDATION WITH REAL-TIME FEEDBACK ---
    function validateStep(stepIndex) {
        let isValid = true;
        document.querySelectorAll('.error-message, .form-input.error').forEach(el => { el.style.display = 'none'; el.classList.remove('error'); });
        const errorEl = document.getElementById('step2-error');
        if(errorEl) errorEl.classList.add('hidden');

        const packages = CONFIG.packages[state.bookingType];
        const pkg = packages.find(p => p.id === state.package);
        const isCommercial = pkg.id === 'commercial' || pkg.flexible;
        
        if (!isCommercial && stepIndex === 1) {
            if (!state.date || !state.time) {
                isValid = false;
                errorEl.textContent = 'Please select a date and time from the calendar.';
            } else if (!state.propertySize || parseInt(state.propertySize, 10) <= 0) {
                isValid = false;
                errorEl.textContent = 'Please enter a valid property size to continue.';
                document.getElementById('property-size').classList.add('error');
            }
            if (!isValid) errorEl.classList.remove('hidden');
        }
        
        // Enhanced validation for step 3 (customer details)
        if (stepIndex === 2) {
            const requiredFields = [
                { id: 'customer-name', message: 'Name is required.' },
                { id: 'customer-email', message: 'A valid email is required.' },
                { id: 'customer-phone', message: 'Phone number is required.' },
                { id: 'customer-address', message: 'Address is required.' },
                { id: 'postal-code', message: 'Postal code is required.' },
                { id: 'city', message: 'City is required.' }
            ];
            
            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                const fieldContainer = input.closest('.field');
                const errorMsg = fieldContainer.querySelector('.error-message');
                const successMsg = fieldContainer.querySelector('.success-message');
                const errorIcon = fieldContainer.querySelector('.validation-icon.error');
                const successIcon = fieldContainer.querySelector('.validation-icon.success');
                
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error');
                    input.classList.remove('valid');
                    if (errorMsg) errorMsg.style.display = 'block';
                    if (successMsg) successMsg.style.display = 'none';
                    if (errorIcon) errorIcon.classList.add('show');
                    if (successIcon) successIcon.classList.remove('show');
                } else {
                    input.classList.remove('error');
                    input.classList.add('valid');
                    if (errorMsg) errorMsg.style.display = 'none';
                    if (successMsg) successMsg.style.display = 'block';
                    if (errorIcon) errorIcon.classList.remove('show');
                    if (successIcon) successIcon.classList.add('show');
                }
            });
        }
        
        // Save progress after each step
        saveProgress();
        
        return isValid;
    }
    
    // --- SAVE PROGRESS FUNCTIONALITY ---
    function saveProgress() {
        try {
            const progressData = {
                activeStep: state.activeStep,
                bookingType: state.bookingType,
                package: state.package,
                date: state.date,
                time: state.time,
                propertySize: state.propertySize,
                customerName: state.customerName,
                customerEmail: state.customerEmail,
                customerPhone: state.customerPhone,
                customerAddress: state.customerAddress,
                postalCode: state.postalCode,
                city: state.city,
                timestamp: Date.now()
            };
            localStorage.setItem('bookingProgress', JSON.stringify(progressData));
            console.log('💾 Progress saved to localStorage');
        } catch (error) {
            console.warn('⚠️ Could not save progress:', error);
        }
    }
    
    function loadProgress() {
        try {
            const savedProgress = localStorage.getItem('bookingProgress');
            if (savedProgress) {
                const progressData = JSON.parse(savedProgress);
                // Only restore if saved within last 24 hours
                if (Date.now() - progressData.timestamp < 24 * 60 * 60 * 1000) {
                    Object.assign(state, progressData);
                    console.log('📂 Progress loaded from localStorage');
                    return true;
                } else {
                    localStorage.removeItem('bookingProgress');
                    console.log('🗑️ Old progress data cleared');
                }
            }
        } catch (error) {
            console.warn('⚠️ Could not load progress:', error);
            localStorage.removeItem('bookingProgress');
        }
        return false;
    }
    
    function clearProgress() {
        localStorage.removeItem('bookingProgress');
        console.log('🗑️ Progress cleared');
    }
    
    // --- SHOW BOOKING DETAILS ---
    function showBookingDetails() {
        // Create a modal to show booking details
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        `;
        
        // Get booking details from state
        const bookingDetails = {
            name: state.customerName || 'N/A',
            email: state.customerEmail || 'N/A',
            phone: state.customerPhone || 'N/A',
            address: state.customerAddress || 'N/A',
            city: state.city || 'N/A',
            postalCode: state.postalCode || 'N/A',
            date: state.date || 'N/A',
            time: state.time || 'N/A',
            package: state.package || 'N/A',
            propertySize: state.propertySize || 'N/A',
            bookingType: state.bookingType || 'N/A'
        };
        
        modalContent.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #1f2937; font-size: 20px;">Booking Details</h3>
                <button id="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
            </div>
            
            <div style="space-y: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Customer Name</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.name}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Email</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.email}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Phone</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.phone}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Booking Type</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.bookingType}</p>
                    </div>
                </div>
                
                <div>
                    <label style="font-weight: 600; color: #374151; font-size: 14px;">Address</label>
                    <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.address}, ${bookingDetails.postalCode} ${bookingDetails.city}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Date</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.date}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Time</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.time}</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Package</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.package}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #374151; font-size: 14px;">Property Size</label>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">${bookingDetails.propertySize} m²</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0; color: #6b7280; font-size: 14px;">
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    A confirmation email has been sent to your email address with all booking details.
                </p>
            </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Add close functionality
        const closeBtn = modal.querySelector('#close-modal');
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        // Close on backdrop click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
        
        // Close on escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                document.body.removeChild(modal);
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    }
    
    // --- REAL-TIME VALIDATION ---
    function setupRealTimeValidation() {
        const inputs = document.querySelectorAll('.form-input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                validateField(this);
            });
            
            input.addEventListener('blur', function() {
                validateField(this);
            });
        });
    }
    
    function validateField(input) {
        const fieldContainer = input.closest('.field');
        const errorMsg = fieldContainer.querySelector('.error-message');
        const successMsg = fieldContainer.querySelector('.success-message');
        const errorIcon = fieldContainer.querySelector('.validation-icon.error');
        const successIcon = fieldContainer.querySelector('.validation-icon.success');
        
        let isValid = true;
        let message = '';
        
        // Field-specific validation
        switch(input.id) {
            case 'customer-name':
                isValid = input.value.trim().length >= 2;
                message = isValid ? 'Name looks good!' : 'Name must be at least 2 characters.';
                break;
            case 'customer-email':
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                isValid = emailRegex.test(input.value);
                message = isValid ? 'Email looks good!' : 'Please enter a valid email address.';
                break;
            case 'customer-phone':
                const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
                isValid = phoneRegex.test(input.value);
                message = isValid ? 'Phone number looks good!' : 'Please enter a valid phone number.';
                break;
            case 'customer-address':
                isValid = input.value.trim().length >= 5;
                message = isValid ? 'Address looks good!' : 'Please enter a complete address.';
                break;
            case 'postal-code':
                isValid = input.value.trim().length >= 4;
                message = isValid ? 'Postal code looks good!' : 'Please enter a valid postal code.';
                break;
            case 'city':
                isValid = input.value.trim().length >= 2;
                message = isValid ? 'City looks good!' : 'Please enter a valid city name.';
                break;
            case 'property-size':
                const size = parseInt(input.value);
                isValid = size > 0 && size <= 1000;
                message = isValid ? 'Size looks good!' : 'Please enter a valid property size (1-1000 m²).';
                break;
        }
        
        // Update UI
        if (isValid) {
            input.classList.remove('error');
            input.classList.add('valid');
            if (errorMsg) errorMsg.style.display = 'none';
            if (successMsg) {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
            }
            if (errorIcon) errorIcon.classList.remove('show');
            if (successIcon) successIcon.classList.add('show');
        } else {
            input.classList.remove('valid');
            input.classList.add('error');
            if (errorMsg) {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            }
            if (successMsg) successMsg.style.display = 'none';
            if (errorIcon) errorIcon.classList.add('show');
            if (successIcon) successIcon.classList.remove('show');
        }
        
        // Update state
        if (input.id.startsWith('customer-')) {
            const fieldName = input.id.replace('customer-', '');
            state[fieldName] = input.value;
        } else if (input.id === 'property-size') {
            state.propertySize = input.value;
        }
        
        // Auto-save progress
        saveProgress();
        
        return isValid;
    }

    // --- LANGUAGE SWITCHER ---
    function setupLanguageSwitcher() {
        const langButtons = document.querySelectorAll('.lang-btn');
        const currentLang = localStorage.getItem('language') || 'en';
        
        // Set initial language
        setLanguage(currentLang);
        
        langButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const lang = btn.dataset.lang;
                setLanguage(lang);
                localStorage.setItem('language', lang);
            });
        });
    }
    
    function setLanguage(lang) {
        // Update button states
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.lang === lang) {
                btn.classList.add('active');
            }
        });
        
        // Apply translations
        const translations = {
            en: {
                'package-title': 'Choose a Package',
                'package-desc': 'Select the type of cleaning that fits your needs.',
                'cleaners-label': 'Cleaners',
                'next-btn': 'Next',
                'back-btn': 'Back',
                'book-btn': 'Book Now',
                'schedule-title': 'Schedule Your Service',
                'schedule-desc': 'Pick a date and time that works for you.',
                'date-label': 'Date',
                'time-label': 'Available Slots',
                'duration-label': 'Duration',
                'details-title': 'Your Details',
                'details-desc': 'Tell us about your property and any special requests.',
                'salutation-label': 'Salutation',
                'name-label': 'Full Name',
                'email-label': 'Email Address',
                'phone-label': 'Phone Number',
                'address-label': 'Street Address',
                'city-label': 'City',
                'postal-label': 'Postal Code',
                'size-label': 'Property Size (m²)',
                'requests-label': 'Special Requests',
                'payment-title': 'Payment',
                'payment-desc': 'Secure payment powered by Stripe.',
                'book-btn': 'Book Now',
                'commercial-message': 'For commercial cleaning, we\'ll contact you to discuss your specific needs and provide a custom quote.',
                'success-title': 'Booking Confirmed!',
                'success-desc': 'Thank you for choosing AJK Cleaning. We\'ll be in touch soon.',
                'support-text': 'International Support'
            },
            de: {
                'package-title': 'Paket wählen',
                'package-desc': 'Wählen Sie die Art der Reinigung, die zu Ihren Bedürfnissen passt.',
                'cleaners-label': 'Reinigungskräfte',
                'next-btn': 'Weiter',
                'back-btn': 'Zurück',
                'book-btn': 'Jetzt buchen',
                'schedule-title': 'Service terminieren',
                'schedule-desc': 'Wählen Sie ein Datum und eine Uhrzeit, die für Sie funktioniert.',
                'date-label': 'Datum',
                'time-label': 'Verfügbare Zeiten',
                'duration-label': 'Dauer',
                'details-title': 'Ihre Daten',
                'details-desc': 'Erzählen Sie uns von Ihrer Immobilie und besonderen Wünschen.',
                'salutation-label': 'Anrede',
                'name-label': 'Vollständiger Name',
                'email-label': 'E-Mail-Adresse',
                'phone-label': 'Telefonnummer',
                'address-label': 'Straßenadresse',
                'city-label': 'Stadt',
                'postal-label': 'Postleitzahl',
                'size-label': 'Grundstücksgröße (m²)',
                'requests-label': 'Besondere Wünsche',
                'payment-title': 'Zahlung',
                'payment-desc': 'Sichere Zahlung über Stripe.',
                'book-btn': 'Jetzt buchen',
                'commercial-message': 'Für gewerbliche Reinigung kontaktieren wir Sie, um Ihre spezifischen Bedürfnisse zu besprechen und ein individuelles Angebot zu erstellen.',
                'success-title': 'Buchung bestätigt!',
                'success-desc': 'Vielen Dank, dass Sie sich für AJK Cleaning entschieden haben. Wir werden uns bald bei Ihnen melden.',
                'support-text': 'Internationaler Support'
            }
        };
        
        const t = translations[lang] || translations.en;
        
        // Apply translations to elements
        Object.keys(t).forEach(key => {
            const elements = document.querySelectorAll(`[data-translate="${key}"]`);
            elements.forEach(el => {
                if (el.tagName === 'INPUT' && el.type === 'text') {
                    el.placeholder = t[key];
                } else {
                    el.textContent = t[key];
                }
            });
        });
    }

    // --- COMMERCIAL BOOKING FUNCTIONS ---
    async function submitCommercialBooking() {
        setLoading(true);
        
        try {
            // Prepare booking details
            const bookingDetails = {
                customerName: state.customerName,
                customerEmail: state.customerEmail,
                customerPhone: state.customerPhone,
                customerAddress: state.customerAddress,
                city: state.city,
                postalCode: state.postalCode,
                bookingType: state.bookingType,
                package: state.package,
                date: state.date,
                time: state.time,
                duration: state.duration,
                cleaners: state.cleaners,
                propertySize: state.propertySize,
                specialRequests: state.specialRequests,
                salutation: state.salutation
            };
            
            console.log('📋 Submitting commercial booking:', bookingDetails);
            
            const response = await fetch('/api/bookings/commercial-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bookingDetails })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                console.log('✅ Commercial booking created successfully:', result);
                setLoading(false);
                showStep(4); // Go to success page
            } else {
                console.error('❌ Failed to create commercial booking:', result);
                setLoading(false);
                showMessage(result.error || 'Failed to create commercial booking. Please try again.');
            }
        } catch (error) {
            console.error('❌ Error submitting commercial booking:', error);
            showMessage('Failed to submit commercial booking. Please try again.');
        } finally {
            setLoading(false);
        }
    }

    // --- STRIPE FUNCTIONS ---
    async function initializeStripe() {
        console.log('🔄 Initializing Stripe payment element...');
        const packages = CONFIG.packages[state.bookingType];
        const pkg = packages.find(p => p.id === state.package);
        
        let total = 0;
        if (pkg.hourly) {
            // For hourly services, calculate based on duration
            total = state.price_per_hour * state.duration * state.cleaners;
        } else {
            // For fixed price services
            total = state.price_per_hour * state.cleaners;
        }
        
        // Prepare booking details to send to server
        const bookingDetails = {
            customerName: state.customerName,
            customerEmail: state.customerEmail,
            customerPhone: state.customerPhone,
            customerAddress: state.customerAddress,
            city: state.city,
            postalCode: state.postalCode,
            bookingType: state.bookingType,
            package: state.package,
            date: state.date,
            time: state.time,
            duration: state.duration,
            cleaners: state.cleaners,
            propertySize: state.propertySize,
            specialRequests: state.specialRequests,
            salutation: state.salutation
        };
        
        try {
            const response = await fetch('/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    totalAmount: total,
                    bookingDetails: bookingDetails
                }),
            });
            const { clientSecret, error, paymentIntentId } = await response.json();
            if(error) { showMessage(error); return; }

            // Store payment intent ID for later use
            state.paymentIntentId = paymentIntentId;

            elements = stripe.elements({ clientSecret });
            paymentElement = elements.create("payment");
            
            console.log('🔧 Creating payment element...');
            
            // Check if payment element container is visible
            const paymentContainer = document.getElementById('payment-element');
            if (!paymentContainer) {
                throw new Error('Payment element container not found');
            }
            console.log('📍 Payment container found:', paymentContainer);
            
            // Wait for the element to be ready before mounting
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Payment element initialization timeout'));
                }, 10000); // 10 second timeout
                
                paymentElement.on('ready', () => {
                    console.log('✅ Payment Element ready, mounting...');
                    clearTimeout(timeout);
                    resolve();
                });
                
                paymentElement.on('loaderror', (error) => {
                    console.error('❌ Payment Element load error:', error);
                    clearTimeout(timeout);
                    reject(error);
                });
                
                // Mount the element
                paymentElement.mount("#payment-element");
            });

            // Additional wait to ensure element is fully mounted and interactive
            await new Promise(resolve => setTimeout(resolve, 1000));
            console.log('✅ Payment element fully mounted and ready');
            
            console.log('✅ Payment Element mounted successfully');
            
            // Ensure the payment element is visible
            paymentContainer.style.display = 'block';
            
            // Enable the payment button only after form is fully loaded
            const submitBtn = document.getElementById('submit-payment');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Pay Now'; // Reset button text
                console.log('✅ Payment button enabled - form is ready for user input');
            }
            
            // Hide any loading indicators
            const paymentMessage = document.getElementById('payment-message');
            if (paymentMessage) {
                paymentMessage.classList.add('hidden');
            }
            paymentContainer.style.visibility = 'visible';
            
        } catch (e) {
            console.error('❌ Stripe initialization error:', e);
            showMessage("Could not connect to payment server. Please try again later.");
            
            // Enable payment button even if Stripe fails (for debugging)
            const submitBtn = document.getElementById('submit-payment');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Pay Now (Retry)';
                console.log('⚠️ Payment button enabled despite Stripe error - for debugging');
            }
        }
    }
    
    async function checkStripeStatus() {
        const clientSecret = new URLSearchParams(window.location.search).get("payment_intent_client_secret");
        if (!clientSecret) return;

        const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);
        if (paymentIntent.status === 'succeeded') {
            // This is a naive way to get data post-redirect. A real app would save state or fetch from a DB.
            const storedState = JSON.parse(localStorage.getItem('bookingState'));
            if(storedState) {
                Object.assign(state, storedState);
            }
            showStep(4); 
            localStorage.removeItem('bookingState');
        } else {
            showMessage("Payment not successful. Please try again.");
        }
    }

    function setLoading(isLoading) {
        const submitBtn = document.getElementById('submit-payment');
        console.log(`🔄 setLoading(${isLoading}) - Button disabled: ${submitBtn.disabled}`);
        if (isLoading) {
            submitBtn.disabled = true;
            // Update button text to show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            showLoadingScreen(); // Show full-screen loading
        } else {
            submitBtn.disabled = false;
            // Restore original button text
            submitBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Pay Now';
            hideLoadingScreen(); // Hide full-screen loading
            console.log('✅ Loading stopped - button should be enabled');
        }
    }

    function showMessage(messageText) {
        const messageContainer = document.querySelector("#payment-message");
        messageContainer.classList.remove("hidden");
        messageContainer.textContent = messageText;
        setTimeout(() => messageContainer.classList.add("hidden"), 5000);
    }

    init();
});
} catch (error) {
    console.error('❌ JAVASCRIPT ERROR:', error);
    console.error('❌ Error details:', error.message);
    console.error('❌ Error stack:', error.stack);
}
</script>
</body>
</html>
